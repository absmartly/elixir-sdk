defmodule ABSmartly.VariantAssignerTest do
  use ExUnit.Case, async: true

  alias ABSmartly.{VariantAssigner, Utils}

  @variant_assignment_cases [
    {"bleh@absmartly.com", [0.5, 0.5], 0, 0, 0},
    {"bleh@absmartly.com", [0.5, 0.5], 0, 1, 1},
    {"bleh@absmartly.com", [0.5, 0.5], 2_148_875_375, 2_130_045_848, 0},
    {"bleh@absmartly.com", [0.5, 0.5], 993_098_128, 3_399_917_389, 0},
    {"bleh@absmartly.com", [0.5, 0.5], 1_388_054_103, 3_528_952_622, 0},
    {"bleh@absmartly.com", [0.5, 0.5], 2_257_487_056, 2_853_234_714, 0},
    {"bleh@absmartly.com", [0.5, 0.5], 668_037_254, 2_218_017_209, 1},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 0, 0, 0},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 0, 1, 2},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 2_148_875_375, 2_130_045_848, 0},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 993_098_128, 3_399_917_389, 1},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 1_388_054_103, 3_528_952_622, 1},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 2_257_487_056, 2_853_234_714, 0},
    {"bleh@absmartly.com", [0.33, 0.33, 0.34], 668_037_254, 2_218_017_209, 1},
    {"123456789", [0.5, 0.5], 0, 0, 1},
    {"123456789", [0.5, 0.5], 0, 1, 0},
    {"123456789", [0.5, 0.5], 2_148_875_375, 2_130_045_848, 1},
    {"123456789", [0.5, 0.5], 993_098_128, 3_399_917_389, 0},
    {"123456789", [0.5, 0.5], 1_388_054_103, 3_528_952_622, 1},
    {"123456789", [0.5, 0.5], 2_257_487_056, 2_853_234_714, 0},
    {"123456789", [0.5, 0.5], 668_037_254, 2_218_017_209, 0},
    {"123456789", [0.33, 0.33, 0.34], 0, 0, 2},
    {"123456789", [0.33, 0.33, 0.34], 0, 1, 1},
    {"123456789", [0.33, 0.33, 0.34], 2_148_875_375, 2_130_045_848, 1},
    {"123456789", [0.33, 0.33, 0.34], 993_098_128, 3_399_917_389, 0},
    {"123456789", [0.33, 0.33, 0.34], 1_388_054_103, 3_528_952_622, 2},
    {"123456789", [0.33, 0.33, 0.34], 2_257_487_056, 2_853_234_714, 0},
    {"123456789", [0.33, 0.33, 0.34], 668_037_254, 2_218_017_209, 0},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 0, 0, 1},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 0, 1, 0},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 2_148_875_375, 2_130_045_848, 1},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 993_098_128, 3_399_917_389, 0},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 1_388_054_103, 3_528_952_622, 1},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 2_257_487_056, 2_853_234_714, 1},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.5, 0.5], 668_037_254, 2_218_017_209, 0},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 0, 0, 2},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 0, 1, 0},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 2_148_875_375, 2_130_045_848, 1},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 993_098_128, 3_399_917_389, 0},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 1_388_054_103, 3_528_952_622, 2},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 2_257_487_056, 2_853_234_714, 1},
    {"e791e240fcd3df7d238cfc285f475e8152fcc0ec", [0.33, 0.33, 0.34], 668_037_254, 2_218_017_209, 1}
  ]

  describe "assign/4 should be deterministic" do
    for {unit, split, seed_hi, seed_lo, expected} <- @variant_assignment_cases do
      split_str = inspect(split)
      @tag_unit unit
      @tag_split split
      @tag_seed_hi seed_hi
      @tag_seed_lo seed_lo
      @tag_expected expected
      test "unit=#{unit} split=#{split_str} seedHi=#{seed_hi} seedLo=#{seed_lo} -> #{expected}" do
        hashed = Utils.hash_unit(@tag_unit)
        assert VariantAssigner.assign(hashed, @tag_split, @tag_seed_hi, @tag_seed_lo) == @tag_expected
      end
    end
  end
end
